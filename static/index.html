<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>MetaXime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
  <!-- styles -->
  <link href="css/styles.css" rel="stylesheet">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) 
  <script src="https://code.jquery.com/jquery.js"></script> -->
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap/bootstrap.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="js/handle_strc.js"></script>
  <script src="js/smiles-drawer_mod.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
        <div class="col-md-2">
          <h1><a href="index.html">MetaXime</a></h1>
        </div>
        <div class="col-md-10">
          <div class="navbar">
            <ul>
              <li class="fa fa-columns" style="color:#DDDDDD;"><a href="index.html">   Dashboard</a></li>
              <li class="fa fa-play-circle" style="color:#DDDDDD;"><a href="runjob.html">   Run Job</a></li>
              <li class="fa fa-question-circle-o" style="color:#DDDDDD;"><a href="help.html">   Help</a></li>
            </ul>
          </div>
        </div>
      </div> <!-- container -->
    </div> <!-- container -->
  </div> <!-- header -->
  <div class="page-content">
    <div class="row" id="mai_row">
      <div class="col-md-12">
	<div class="row" id="to_add_boxes">
	</div>
      </div>
    </div>
  </div>

  <script>
    function makeDashBoard() {
      $.ajax({
	url: 'http://'+location.host+':8888/REST/GetJobList',
	type: 'POST',
	data: JSON.stringify({}),
	processData: false,
	contentType: 'application/json',
	dataType: 'json',
	success: function(response) {
	  //clear the elements
	  parent_div = document.getElementById('to_add_boxes');
	  parent_div.innerHTML = '';
	  //console.log(response);
	  $.each(response, function(i, val) {
	    //console.log(i);
	    //console.log(val);
	    makeDash(val);
	  });
	},
	headers: {
	    'Access-Control-Allow-Origin': '*'
	}
      });
    }
    makeDashBoard();
  </script>


  <script>
    function deleteDash(job_id, name) {
    var r = confirm("Are you sure you want to delete: "+name);
    if (r==true) {
	console.log('Deleting: '+job_id)
	$.ajax({
	  url: 'http://'+location.host+':8888/REST/DeleteResult',
	  type: 'POST',
	  data: JSON.stringify({'job_id': job_id}),
	  processData: false,
	  contentType: 'application/json',
	  dataType: 'json',
	  success: function(response) {
	    console.log(response);
	    let div6 = document.getElementById(job_id+"__box");
	    div6.innerHTML = "";
	  }
	});
      }
    }
  </script>

  <script>
    function makeDash(dash_dict) {
      var perc_done = dash_dict["job"]["meta"]["progress"]*100.0/13.0
      perc_done = perc_done.toFixed(1)
      var rightList = [dash_dict["input"]["gem"], dash_dict["input"]["steps"], dash_dict["job"]["status"], perc_done.toString()+'%', dash_dict["job"]["meta"]["err_msg"]]
      var leftList = ["Organism", "Max Steps", "Job Status", "Job Progress", "Error Message"];
      var listIDs = ["orga", "steps", "job_status", "job_pro", "err_msg"];
      //box header
      let div_box_header = document.createElement("div");
      div_box_header.className = "content-box-header";
	//box header title
      div_box_header.innerHTML = '<div class="panel-options"><a href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-cog" style="color:#2c3742;"></i></a><div class="dropdown-menu"><a class="dropdown-item" href="#" id="'+dash_dict["job"]["id"]+'__delete">Delete</a></div></div>';
	let div_box_header_title = document.createElement("div");
	div_box_header_title.className = "panel-title";
	div_box_header_title.innerHTML = 'Project: '+dash_dict["input"]["name"];
	div_box_header.append(div_box_header_title);
      //box content
      let div_box_content = document.createElement("div");
      div_box_content.className = "content-box-large box-with-header";
	//seperate the box content into text and canvas
	var div_box_desc = document.createElement("div");
	div_box_desc.className = "row";
	  //table ie. two lists side by side
	  var div_box_desc_1 = document.createElement("div");
	  div_box_desc_1.className = "col-sm no-gutters";
	    var info_list = document.createElement('ul');
	    for (var i = 0; i < leftList.length; i++) {
	      var tmp_li = document.createElement('li');
	      tmp_li.className = "list-group-item";
	      tmp_li.id = dash_dict["job"]["id"]+"__"+listIDs[i];
	      tmp_li.innerHTML = "<b>"+leftList[i]+"</b>: "+rightList[i];
	      info_list.append(tmp_li);
	    }
	  div_box_desc_1.append(info_list);
	div_box_desc.append(div_box_desc_1);
	  var div_box_desc_2 = document.createElement("div");
	  div_box_desc_2.className = "col-sm no-gutters";
	    var canvas = document.createElement('canvas');
	    canvas.setAttribute('width', 200);
	    canvas.setAttribute('height', 200);
	    canvas.id = dash_dict["job"]["id"]+"__strc";
	    //canvas.onclick=;
	  div_box_desc_2.append(canvas);
	div_box_desc.append(div_box_desc_2); 
	btn = document.createElement('button');
	btn.className = "btn btn-default btn-block";
	btn.innerHTML = "Examine";
	btn.id = dash_dict["job"]["id"]+"__btn";
	if (dash_dict["job"]["status"]=="finished") {
	  btn.disabled = false;
	}
	else {
	  btn.disabled = true;
	}
	//btn.onclick = open("results.html?jobid="+dash_dict["job"]["id"]);
	btn.addEventListener("click", function(){
	    window.open("result.html?jobid="+dash_dict["job"]["id"]);	
	  },
	  false);
	div_box_desc.append(btn);
      div_box_content.append(div_box_desc);
      //div_box_content.append(document.createElement('br'));
      //highest level
      div12 = document.createElement("div");
      div12.className = "col-md-12";
      div12.append(div_box_header);
      div12.append(div_box_content);
      row6 = document.createElement("div");
      row6.className = "row";
      row6.append(div12);
      div6 = document.createElement("div");
      div6.className = "col-md-6";
      div6.id = dash_dict["job"]["id"]+"__box";
      div6.append(row6);
      parent_div = document.getElementById('to_add_boxes');
      parent_div.append(div6);
      //console.log(dash_dict["input"]["smiles"])
      //add the other properties dynamically
      var delete_elem = document.getElementById(dash_dict["job"]["id"]+"__delete");
      delete_elem.addEventListener("click", function(){
	  deleteDash(dash_dict["job"]["id"], dash_dict["input"]["name"]);	  
	},
	false);
      makeStrc(dash_dict["input"]["smiles"], dash_dict["job"]["id"]+"__strc", 200, 200);
    }
  </script>

  <script>
    function updateBashBoard() {
      $.ajax({
	url: 'http://'+location.host+':8888/REST/GetJobList',
	type: 'POST',
	data: JSON.stringify({}),
	processData: false,
	contentType: 'application/json',
	dataType: 'json',
	success: function(response) {
	  //console.log(response);
	  $.each(response, function(i, dash_dict) {
	    //console.log(i);
	    //console.log(dash_dict);
	    var listIDs = ["job_status", "job_pro", "err_msg"];
	    var leftList = ["Job Status", "Job Progress", "Error Message"];
	    var perc_done = dash_dict["job"]["meta"]["progress"]*100.0/13.0;
	    perc_done = perc_done.toFixed(1);
	    var rightList = [dash_dict["job"]["status"], perc_done.toString()+'%', dash_dict["job"]["meta"]["err_msg"]]
	    for (var i = 0; i < listIDs.length; i++) {
	      let up_li = document.getElementById(dash_dict["job"]["id"]+"__"+listIDs[i]);
	      //if its null then we must create it
	      if (up_li==null) {
		makeDash(dash_dict);
	      }
	      else {
		up_li.innerHTML = "<b>"+leftList[i]+"</b>: "+rightList[i];
	      }
	    }
	    //disable the btn if the job is not finished
	    if (dash_dict["job"]["status"]=="finished") {
	      document.getElementById(dash_dict["job"]["id"]+"__btn").disabled = false;
	    }
	    else{
	      document.getElementById(dash_dict["job"]["id"]+"__btn").disabled = true;
	    }
	  });
	}
      }); 
    }
    //every 60s reload to see if the jobs have been updated
    //TODO: only if on or more are queued or running
    setInterval(function() {
      updateBashBoard();
    }, 30000);
  </script>
  <footer>
    <div class="container">
      <div class="copy text-center">
	Created by: <a href='http://github.com/melclic/'>Melchior du Lac</a>
      </div>
    </div>
  </footer>
</body>
</html>
