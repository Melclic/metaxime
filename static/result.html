<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>MetaXime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
  <link href="css/jquery.dataTables.min.css" rel="stylesheet">
  <link href='css/dagre_styles.css' rel='stylesheet' type='text/css'/>
  <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/jquery.dataTables.min.js"></script>
  <script src="js/bootstrap/bootstrap.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="js/handle_strc.js"></script>
  <script src="js/smiles-drawer_mod.js"></script>
  <script src='js/d3.v6.min.js'></script>
  <script src='js/dagre-d3.min.js'></script>
  <script src='js/draw_network.js'></script>
  <!-- <script src='js/tables.js'></script> -->
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
	<div class="col-md-2">
	  <h1><a href="index.html">MetaXime</a></h1>
	</div>
	<div class="col-md-10">
	  <div class="navbar">
	    <ul>
	      <li class="fa fa-columns" style="color:#DDDDDD;"><a href="index.html">   Dashboard</a></li>
	      <li class="fa fa-play-circle" style="color:#DDDDDD;"><a href="runjob.html">   Run Job</a></li>
	      <li class="fa fa-question-circle-o" style="color:#DDDDDD;"><a href="help.html">   Help</a></li>
	    </ul>
	  </div>
	</div>
      </div> <!-- container -->
    </div> <!-- container -->
  </div> <!-- header -->
  <div class="page-content">
    <div class="row">
      <div class="col-md-12">
	<div class="row">
	  <div class="container-fluid">
	    <div class="content-box-large" id="res_list_box">
	      <!-- results table -->
	      <div class="panel-body">
		<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-hover" id="res_list_table">
		  <thead>
		    <tr>
		      <th>Name</th>
		      <th>dG</th>
		      <th>FBA</th>
		      <th>Steps</th>
		    </tr>
		  </thead>
		  <tbody id="res_list_tbody">
		  </tbody>
		</table>
	      </div>
	    </div>
	  </div>
	</div>
	<div class="row">
	  <div class="container-fluid">
	    <div class="content-box-header">
	      <div class="panel-title" id="network_panel_title">Select pathway</div>
	    </div>
	    <div class="content-box-large box-with-header">
	      <div class="network" id="network">
		<!-- dagre -->
	      </div>
	    </div>
	  </div>
	</div>
      </div>
    </div>
  </div>

  <script>
    //######## create the table #########
    let params = new URLSearchParams(location.search);
    var job_id = params.get('jobid');
    $.ajax({
      url: 'http://'+location.host+':8888/REST/GetResults',
      type: 'POST',
      data: JSON.stringify({'job_id': job_id}),
      processData: false,
      contentType: 'application/json',
      dataType: 'json',
      success: function(response) {
	//console.log(response);
	var tbody = document.getElementById("res_list_tbody");
	$.each(response, function(i, val) {
	  var json = JSON.parse(val);
	  var row = document.createElement("tr");
	  //name
	  var col_name = document.createElement("td");
	  col_name.innerHTML = json["name"].replace("_rpsbml", "");
	  row.append(col_name);
	  //dG
	  var col_dg = document.createElement("td");
	  col_dg.innerHTML = json["pathway"]["brsynth"]["dfG_prime_o"]["value"];
	  row.append(col_dg);
	  //fba
	  var col_fba = document.createElement("td");
	  col_fba.innerHTML = json["pathway"]["brsynth"]["fba_obj_fraction"]["value"];
	  row.append(col_fba);
	  //steps
	  var col_steps = document.createElement("td");
	  col_steps.innerHTML = Object.keys(json["reactions"]).length;
	  row.append(col_steps);
	  row.addEventListener("click", function(){
	    console.log(this.id);
	    makeNetwork(this.id);
	  });
	  row.id = json["name"];
	  tbody.append(row)
	});
	$('#res_list_table').DataTable();
      }
    });
  </script>

  <script>
    function makeNetwork(rpsbml_id) {
      var network = document.getElementById("network");
      network.innerHTML = "";
      var network_title = document.getElementById("network_panel_title");
      network_title.innerHTML = "Network of model "+rpsbml_id.replace("_rpsbml", "");
      let params = new URLSearchParams(location.search);
      var job_id = params.get('jobid');
      $.ajax({
        url: 'http://'+location.host+':8888/REST/GetNetwork',
        type: 'POST',
        data: JSON.stringify({'job_id': job_id, 'rpsbml_id': rpsbml_id}),
        processData: false,
        contentType: 'application/json',
        dataType: 'json',
        success: function(response) {
	  const zoom = d3.zoom()
	    .on('zoom', zoomed)
	    .scaleExtent([0.5, 7]);
	    //.translateExtent([[-100,-100],[100,100]]);
	  //make the graph of the reaction
	  var svg = d3.select('div#network')
		  .append('svg')
			.attr('width', '100%')
			.attr('height', '500px')
		    .attr("id", "dagre_svg")
		    .call(zoom)
	  var dagre_g = svg.append("g");
	      //WARNING: here the passed svg is useless -- but if passed does not take the twole page
	  function zoomed(event) {
	    dagre_g.attr("transform", event.transform);
	  }
	  drawNetwork(svg, response, true, zoom);
	  zoomFit(zoom, svg, 10);
	}
      });
    }
  </script>
  <footer>
    <div class="container">
      <div class="copy text-center">
	Created by: <a href='http://github.com/melclic/'>Melchior du Lac</a>
      </div>
    </div>
  </footer>
</body>
</html>
