<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <!-- 
  <script src="bower_components/d3/d3.js"></script>
  <script src="bower_components/lodash/lodash.js"></script>
  <script src="bower_components/graphlib/dist/graphlib.core.js"></script>
  <script src="bower_components/dagre/dist/dagre.core.js"></script>
  <script src="bower_components/dagre-d3/dist/dagre-d3.core.js"></script>
  -->
  <!-- <script src="pkgs/d3.v6.js"></script> -->
  <script src="pkgs/d3.v6.js"></script>
  <script src="pkgs/dagre-d3.js"></script>
  <script src="pkgs/smiles-drawer.js"></script>
  <script src="pkgs/fabric.min.js"></script>
</head>
<style id="css">


h1 {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  margin-top: 0.8em;
  margin-bottom: 0.2em;
}

text {
  font-weight: 300;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  font-size: 14px;
}

.node rect {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.node polygon {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path.path {
  stroke: #333;
  fill: none;
  stroke-width: 1.5px;
}

div#top-frame {
  height: 350px;
}

div#WBS-frame {
  float: left;
  width: 50%;
}

div#dependencies-frame {
  float: left;
  width: 50%;
}

div#schedule-frame {
  float: none;
}
</style>
<body>
  <script>	
	var svg = d3.select("body")
		.append("svg")
		  .attr("width", window.innerWidth)
		  .attr("height", window.innerHeight)
		  .attr('id', 'test_svg')
		.append("g");	


	//var svg = d3.select('svg'),
	inner = svg.select('g');


	// Create the input graph
	var g = new dagreD3.graphlib.Graph()
	  .setGraph({nodesep: 30,
				 ranksep: 150,
				 rankdir: "LR",
				 marginx: 10,
				 marginy: 10
	  })
	  .setDefaultEdgeLabel(function() { return {}; });



	d3.json("networkx.json").then(function(graph) {

	  console.log(graph)
	  //add the nodes
	  for (var i = 0; i < graph.nodes.length; i++){
		var chem_svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
		chem_svg.setAttribute("width", "100");
		chem_svg.setAttribute("height", "100");
		chem_svg.id = 'svg_'+graph.nodes[i].id 
		//document.body.appendChild(chem_svg)
		if(graph.nodes[i].type=='species') {
		  g.setNode(graph.nodes[i].id, {labelType: 'html',
										label: chem_svg,
										width: 100,
										height: 100}
		  );
		  /*
		  g.setNode(graph.nodes[i].id, {labelType: 'svg', label: chem_svg})
		  */
		}
		if(graph.nodes[i].type=='reaction') {
		  g.setNode(graph.nodes[i].id, {labelType: 'string', label: graph.nodes[i].id, height: 50, width: 100}); 
		}
	  }
	  
	  //add the links
	  for (var i = 0; i < graph.links.length; i++){
		g.setEdge(graph.links[i].source, graph.links[i].target);
	  }

	  g.nodes().forEach(function(v) {
		var node = g.node(v);
		// Round the corners of the nodes
		node.rx = node.ry = 5;
	  });

	  // Create the renderer
	  var render = new dagreD3.render();

	  // Set up an SVG group so that we can translate the final graph.
	  var svg = d3.select("svg"),
		  svgGroup = svg.append("g");


	  // Run the renderer. This is what draws the final graph.
	  render(d3.select("svg g"), g);

	  // Center the graph
	  svg.attr("height", g.graph().height + 40);

	  //draw the molecules in the canvas
	  for (var i = 0; i < graph.nodes.length; i++){
		if(graph.nodes[i].type=='species'){
		  canvas_static = document.getElementById('svg_'+graph.nodes[i].id)
		  //makeSVGstrc(graph.nodes[i].brsynth.smiles.toUpperCase(), canvas_static, 92, 92) 
		  makeSVGstrc(graph.nodes[i].brsynth.smiles.toUpperCase(), 'svg_'+graph.nodes[i].id, 100, 100) 
		}
	  }
	  /*
	  for (var i = 0; i < graph.nodes.length; i++){
		if(graph.nodes[i].type=='species'){
		  canvas_static = document.getElementById('svg_'+graph.nodes[i].id)
		  var rect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
		  rect.setAttributeNS(null, 'x', 0);
		  rect.setAttributeNS(null, 'y', 0);
		  rect.setAttributeNS(null, 'height', '50');
		  rect.setAttributeNS(null, 'width', '50');
		  rect.setAttributeNS(null, 'fill', 'red');
		  canvas_static.appendChild(rect);
		}
	  }
	  */

		  /*
	  // Set up zoom support
svg.call(d3.zoom()
      .extent([[0, 0], [100, 100]])
      .scaleExtent([1, 8])
      .on("zoom", zoomed));

function zoomed({transform}) {
    svg.attr("transform", transform);
	
  }
*/

	});

	//################ functions ########################

	function makestrc(input, in_canvas, in_width, in_height) {
	  smilesdrawer = new SmilesDrawer.Drawer({ width: in_width, height: in_height, explicitHydrogens: false});
	  SmilesDrawer.parse(input, function(tree) {
			// draw to the canvas
			smilesdrawer.draw(tree, in_canvas, "light", false);
			// alternatively, draw to svg:
			//svgdrawer.draw(tree, canvas, 'dark', false);
		  });
	}

    function makeSVGstrc(input, in_html_element, in_width, in_height) {
      svgDrawer = new SmilesDrawer.SvgDrawer({ width: in_width, height: in_height, experimental: true, compactDrawing:false, terminalCarbons:true, explicitHydrogens: false, bondThickness: 0.8, atomVisualization: 'default'});
      SmilesDrawer.parse(input, function(tree) {
        // draw to the canvas
        //smilesdrawer.draw(tree, in_canvas, "light", false);
        // alternatively, draw to svg:
        svgDrawer.draw(tree, in_html_element, 'light', false);
      });
    }


  </script>
</body>

