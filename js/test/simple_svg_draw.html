<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="pkgs/smiles-drawer_mel.js"></script>
  <script src="pkgs/jquery-3.5.1.js"></script>
  <!-- <script src="pkgs/d3.v6.js"></script> -->

  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Smiles Drawer Example</title>
  <meta name="description" content="A minimal smiles drawer example." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700"
    rel="stylesheet"
  />
</head>
<body>
	<canvas id="example-canvas" width="100" height="100"></canvas>
  <script>

/*
	//######### classical #########

	var static_canvas = document.getElementById('output-svg')
	console.log(isElement(static_canvas))
	console.log(static_canvas)
    //makeSVGstrc('[H]N=C(O[H])C1=C([H])N(C2([H])OC([H])(C([H])([H])OP(=O)(O[H])OP(=O)(O[H])OC([H])([H])C3([H])OC([H])(n4c([H])nc5c(N([H])[H])nc([H])nc54)C([H])(OP(=O)(O[H])O[H])C3([H])O[H])C([H])(O[H])C2([H])O[H])C([H])=C([H])C1([H])[H]'.toUpperCase(), 'output-svg', cmp_width, cmp_height);
    //makeSVGstrc('[H]OC(=O)C([H])=C([H])C([H])=C([H])C(=O)O[H]', static_canvas, cmp_width, cmp_height);
	console.log(static_canvas)


  */
	/*
	//######### create SVG dynamically ########

	var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	svg.id = 'dyn-svg'
	svg.setAttribute("width", "300");
	svg.setAttribute("height", "300");
	//document.body.appendChild(svg)
	console.log(svg)
	document.body.appendChild(svg)
	//makeSVGstrc('[H]N=C(O[H])C1=C([H])N(C2([H])OC([H])(C([H])([H])OP(=O)(O[H])OP(=O)(O[H])OC([H])([H])C3([H])OC([H])(n4c([H])nc5c(N([H])[H])nc([H])nc54)C([H])(OP(=O)(O[H])O[H])C3([H])O[H])C([H])(O[H])C2([H])O[H])C([H])=C([H])C1([H])[H]'.toUpperCase(), 'dyn-svg', cmp_width, cmp_height);
	makeSVGstrc('[H]N=C(O[H])C1=C([H])N(C2([H])OC([H])(C([H])([H])OP(=O)(O[H])OP(=O)(O[H])OC([H])([H])C3([H])OC([H])(n4c([H])nc5c(N([H])[H])nc([H])nc54)C([H])(OP(=O)(O[H])O[H])C3([H])O[H])C([H])(O[H])C2([H])O[H])C([H])=C([H])C1([H])[H]'.toUpperCase(), svg, 300, 300);
	console.log(svg)
	//save the svg to file
	var serializer = new XMLSerializer();
	var source = serializer.serializeToString(svg);
	console.log(source)
	//add name spaces.
	if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
	    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
	}
	if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
	    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
	}
	//add xml declaration
	source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
	//convert svg source to URI data scheme.
	var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);
	//set url value to a element's href attribute.
	//document.getElementById("link").href = url; 
	//download('img/test.svg', source);
	//svg.parentNode.removeChild(svg);
	*/

	all_svg = {};
	readTextFile("networkx.json", function(text) {
	  var graph = JSON.parse(text);
	  console.log(graph)
	  //add the nodes
	  for (var i = 0; i < graph.nodes.length; i++) {
	    //chem_svg.parentNode.removeChild(chem_svg);
	    //document.body.appendChild(chem_svg)
	    if(graph.nodes[i].type=='species') {
	      var chem_svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	      chem_svg.id = 'svg_'+graph.nodes[i].id;
	      chem_svg.setAttribute("width", "300");
	      chem_svg.setAttribute("height", "300");
	      console.log(chem_svg)
	      console.log(graph.nodes[i].brsynth.smiles.toUpperCase())
	      document.body.appendChild(chem_svg); //need to append to document to draw
	      makeSVGstrc(graph.nodes[i].brsynth.smiles.toUpperCase(), chem_svg, 300, 300);
	      console.log(chem_svg);
	      //var serializer = new XMLSerializer();
	      //var source = serializer.serializeToString(chem_svg);
	      //console.log(source)
	      //all_svg[graph.nodes[i].id] = source;
	      //chem_svg.parentNode.removeChild(chem_svg); 
	    }
	  }
	});
	console.log(all_svg)

    //Returns true if it is a DOM element    
    function isElement(o){
      return (
	typeof HTMLElement === "object" ? o instanceof HTMLElement : //DOM2
	o && typeof o === "object" && o !== null && o.nodeType === 1 && typeof o.nodeName==="string"
    );
    }

    //##################### functions ##########################

    function readTextFile(file, callback) {
	var rawFile = new XMLHttpRequest();
	rawFile.overrideMimeType("application/json");
	rawFile.open("GET", file, true);
	rawFile.onreadystatechange = function() {
	    if (rawFile.readyState === 4 && rawFile.status == "200") {
		callback(rawFile.responseText);
	    }
	}
	rawFile.send(null);
    }


    function download(filename, text) {
	var pom = document.createElement('a');
	pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	pom.setAttribute('download', filename);

	if (document.createEvent) {
	    var event = document.createEvent('MouseEvents');
	    event.initEvent('click', true, true);
	    pom.dispatchEvent(event);
	}
	else {
	    pom.click();
	}
    }

    function makeStrc(input, canvas, width, height) {
      smilesDrawer = new SmilesDrawer.Drawer({ width: width, height: height });
      SmilesDrawer.parse(input, function(tree) {
	    // Draw to the canvas
	    smilesDrawer.draw(tree, canvas, "light", false);
	    // Alternatively, draw to SVG:
	    //svgDrawer.draw(tree, canvas, 'dark', false);
	  });
    }

    function makeSVGstrc(input, in_html_element, in_width, in_height) {
      svgDrawer = new SmilesDrawer.SvgDrawer({ width: in_width, height: in_height, explicitHydrogens: false, bondThickness: 0.8, atomVisualization: 'default'});
      SmilesDrawer.parse(input, function(tree) {
	    // draw to the canvas
	    //smilesdrawer.draw(tree, in_canvas, "light", false);
	    // alternatively, draw to svg:
	    svgDrawer.draw(tree, in_html_element, 'light', false);
	  });
    }
  </script>
</body>
